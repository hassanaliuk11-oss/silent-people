<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Souls - Writing Pad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,700;1,700&family=Poppins:wght@300;400;500&family=Montserrat:wght@200;300;400&display=swap" rel="stylesheet">
    <style>
        body { background: #fdfdfd; font-family: 'Poppins', sans-serif; color: #1a1a1a; }
        .main-title { font-family: 'Playfair Display', serif; letter-spacing: -0.02em; }
        .author-brand { font-family: 'Bodoni Moda', serif; letter-spacing: 0.15em; text-transform: uppercase; }
        .post-card { transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .post-card:hover { box-shadow: 0 20px 40px rgba(0, 0, 0, 0.04); transform: translateY(-2px); border-color: #e5e5e5; }
        .action-btn { opacity: 0; transition: opacity 0.3s ease; }
        .post-card:hover .action-btn { opacity: 1; }
        .input-elegant:focus { border-bottom: 1.5px solid #9a845a !important; }
        .gold-accent { color: #9a845a; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4 md:p-12 min-h-screen flex flex-col">

<div class="max-w-3xl mx-auto flex-grow w-full">
    <!-- Header Section -->
    <div class="text-center mb-16 mt-8">
        <h1 class="main-title text-6xl md:text-7xl text-gray-900 mb-4">Silent Souls</h1>
        <div class="flex flex-col items-center">
            <div class="flex items-center gap-4 mb-2">
                <span class="h-[1px] w-8 bg-gray-200"></span>
                <p class="author-brand text-sm md:text-base font-light tracking-[0.3em] text-gray-500">
                    Author <span class="gold-accent font-normal mx-1">•</span> <span class="text-gray-800 font-medium">Hassan Jatoi</span>
                </p>
                <span class="h-[1px] w-8 bg-gray-200"></span>
            </div>
        </div>
        <div class="w-12 h-[2px] bg-gray-900 mx-auto mt-10 opacity-20"></div>
    </div>

    <!-- WRITING SECTION (Force Visible for Login) -->
    <div id="authorSection" class="bg-white rounded-[2rem] shadow-[0_10px_50px_rgba(0,0,0,0.03)] border border-gray-50 p-10 mb-20 text-center">
        <!-- Textarea will hide for non-authors after check -->
        <textarea id="userInput" 
                  class="hidden w-full h-48 p-4 text-center text-2xl text-gray-700 bg-transparent border-none focus:ring-0 outline-none transition-all resize-none placeholder-gray-200 italic font-serif" 
                  placeholder="Capture the silence..."></textarea>
        
        <div class="flex flex-col items-center mt-4 gap-6">
            <div class="w-full max-w-[180px]">
                <input type="password" id="accessCode" 
                       class="input-elegant w-full text-center border-b border-gray-100 py-2 outline-none transition-all placeholder-gray-300 text-sm tracking-[0.2em] uppercase" 
                       placeholder="Enter Key">
            </div>

            <button onclick="publishPost()" id="publishBtn"
                    class="bg-[#1a1a1a] hover:bg-black text-white text-sm uppercase tracking-widest font-medium py-4 px-12 rounded-full transition-all flex items-center gap-3 shadow-xl active:scale-95">
                <span id="btnText">Unlock & Publish</span>
            </button>
            <button id="cancelEdit" onclick="cancelEditing()" class="hidden mt-2 text-[10px] uppercase tracking-widest text-red-400">Cancel Editing</button>
        </div>
    </div>

    <div id="readerNotice" class="text-center mb-16 hidden">
        <p class="text-gray-400 text-sm italic font-light tracking-wide">Exploring the depths of silence through the words of Hassan Jatoi.</p>
    </div>

    <!-- Feed Section -->
    <div class="mb-24">
        <div id="feed" class="space-y-12">
            <div class="text-center text-gray-300 py-10 italic font-serif">Summoning the ink...</div>
        </div>
    </div>
</div>

<footer class="mt-auto py-16 text-center border-t border-gray-50 bg-[#fafafa]">
    <a href="https://hassanalipoetry.vercel.app/" target="_blank" class="inline-block group">
        <span class="text-2xl font-serif italic text-gray-800 border-b border-transparent group-hover:border-gray-800 transition-all duration-500 pb-1">
            Poetry Portfolio <span class="gold-accent">→</span>
        </span>
    </a>
</footer>

<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 hidden bg-[#1a1a1a] text-white px-10 py-4 rounded-full shadow-2xl z-50 text-xs uppercase tracking-[0.2em]"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'silent-souls-v2';
    
    const MASTER_CODE = "0786";

    let currentUser = null;
    let isAuthor = false;
    let editingPostId = null;

    // Login logic
    async function initAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await checkAuthorPermission(user);
            setupFeedListener();
        }
    });

    initAuth();

    async function checkAuthorPermission(user) {
        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'authorSettings');
        try {
            const configSnap = await getDoc(configRef);
            if (!configSnap.exists()) {
                // First user becomes author
                await setDoc(configRef, { authorUid: user.uid });
                isAuthor = true;
            } else {
                isAuthor = configSnap.data().authorUid === user.uid;
            }

            if (isAuthor) {
                document.getElementById('userInput').classList.remove('hidden');
                document.getElementById('btnText').innerText = "Publish Thought";
            } else {
                // If not recognized yet, keep the password field to allow "Logging in" via MASTER_CODE
                document.getElementById('readerNotice').classList.remove('hidden');
            }
        } catch (e) { console.error(e); }
    }

    window.publishPost = async function() {
        const codeInput = document.getElementById('accessCode');
        const textArea = document.getElementById('userInput');
        const btn = document.getElementById('publishBtn');

        if (codeInput.value !== MASTER_CODE) {
            showToast("Invalid Key");
            return;
        }

        // Emergency: If master code is correct, ensure this user becomes the author in DB
        if (!isAuthor && currentUser) {
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'authorSettings');
            await updateDoc(configRef, { authorUid: currentUser.uid });
            isAuthor = true;
            textArea.classList.remove('hidden');
            showToast("Author Verified");
        }

        const text = textArea.value.trim();
        if (text === "" && isAuthor) { showToast("Empty Inkwell"); return; }
        if (text === "") return; // Just logged in

        btn.disabled = true;
        try {
            if (editingPostId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', editingPostId), { 
                    content: text, lastEdited: serverTimestamp() 
                });
                cancelEditing();
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'articles'), {
                    content: text, createdAt: serverTimestamp(), authorId: "Hassan Jatoi"
                });
                textArea.value = "";
            }
            showToast("Success");
            codeInput.value = "";
        } catch (e) { showToast("Error"); }
        finally { btn.disabled = false; }
    };

    function setupFeedListener() {
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'articles'), (snapshot) => {
            const articles = [];
            snapshot.forEach(doc => articles.push({ id: doc.id, ...doc.data() }));
            articles.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            renderFeed(articles);
        });
    }

    function renderFeed(articles) {
        const feed = document.getElementById('feed');
        feed.innerHTML = articles.map(post => `
            <div class="post-card p-12 rounded-[2rem] border border-gray-50 text-center relative">
                ${isAuthor ? `<div class="absolute top-8 right-8 flex gap-3 action-btn">
                    <button onclick="editPost('${post.id}', \`${post.content.replace(/`/g, '\\`')}\`)" class="text-gray-300 hover:text-black">Edit</button>
                    <button onclick="deletePost('${post.id}')" class="text-gray-300 hover:text-red-500">Delete</button>
                </div>` : ''}
                <p class="text-3xl text-gray-800 leading-[1.6] font-serif italic">"${post.content}"</p>
                <div class="mt-8 text-[10px] uppercase tracking-widest text-gray-400">— Hassan Jatoi</div>
            </div>
        `).join('');
    }

    window.editPost = (id, content) => {
        editingPostId = id;
        document.getElementById('userInput').value = content;
        document.getElementById('btnText').innerText = "Update";
        document.getElementById('cancelEdit').classList.remove('hidden');
        window.scrollTo(0, 0);
    };

    window.cancelEditing = () => {
        editingPostId = null;
        document.getElementById('userInput').value = "";
        document.getElementById('btnText').innerText = "Publish Thought";
        document.getElementById('cancelEdit').classList.add('hidden');
    };

    window.deletePost = async (id) => {
        if(confirm("Delete?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', id));
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.remove('hidden');
        setTimeout(() => t.classList.add('hidden'), 3000);
    }
</script>
</body>
</html>
