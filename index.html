<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silent Souls - Writing Pad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a premium literary look -->
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,700;1,700&family=Poppins:wght@300;400;500&family=Montserrat:wght@200;300;400&display=swap" rel="stylesheet">
    <style>
        body { 
            background: #fdfdfd; 
            font-family: 'Poppins', sans-serif;
            color: #1a1a1a;
        }
        .main-title { 
            font-family: 'Playfair Display', serif; 
            letter-spacing: -0.02em;
        }
        .author-brand {
            font-family: 'Bodoni Moda', serif;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }
        .post-card { 
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }
        .post-card:hover { 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
            border-color: #e5e5e5;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 10px; }
        
        .action-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .post-card:hover .action-btn {
            opacity: 1;
        }
        
        .input-elegant:focus {
            border-bottom: 1.5px solid #9a845a !important;
        }

        .gold-accent {
            color: #9a845a; 
        }
    </style>
</head>
<body class="p-4 md:p-12 min-h-screen flex flex-col">

<div class="max-w-3xl mx-auto flex-grow w-full">
    <!-- Header Section -->
    <div class="text-center mb-16 mt-8">
        <h1 class="main-title text-6xl md:text-7xl text-gray-900 mb-4">Silent Souls</h1>
        
        <div class="flex flex-col items-center">
            <div class="flex items-center gap-4 mb-2">
                <span class="h-[1px] w-8 bg-gray-200"></span>
                <p class="author-brand text-sm md:text-base font-light tracking-[0.3em] text-gray-500">
                    Author <span class="gold-accent font-normal mx-1">•</span> <span class="text-gray-800 font-medium">Hassan Jatoi</span>
                </p>
                <span class="h-[1px] w-8 bg-gray-200"></span>
            </div>
            <p class="text-[10px] uppercase tracking-[0.5em] text-gray-400 mt-1">Official Literary Archive</p>
        </div>
        
        <div class="w-12 h-[2px] bg-gray-900 mx-auto mt-10 opacity-20"></div>
    </div>

    <!-- Writing Section (Initially Hidden via CSS but managed by JS) -->
    <div id="authorSection" class="hidden bg-white rounded-[2rem] shadow-[0_10px_50px_rgba(0,0,0,0.03)] border border-gray-50 p-10 mb-20 text-center">
        <textarea id="userInput" 
                  class="w-full h-48 p-4 text-center text-2xl text-gray-700 bg-transparent border-none focus:ring-0 outline-none transition-all resize-none placeholder-gray-200 italic font-serif" 
                  placeholder="Capture the silence..."></textarea>
        
        <div class="flex flex-col items-center mt-8 gap-6">
            <div class="w-full max-w-[180px]">
                <input type="password" id="accessCode" 
                       class="input-elegant w-full text-center border-b border-gray-100 py-2 outline-none transition-all placeholder-gray-300 text-sm tracking-[0.2em] uppercase" 
                       placeholder="Security Code">
            </div>

            <button onclick="publishPost()" 
                    id="publishBtn"
                    class="bg-[#1a1a1a] hover:bg-black text-white text-sm uppercase tracking-widest font-medium py-4 px-12 rounded-full transition-all flex items-center gap-3 shadow-xl active:scale-95">
                <span id="btnText">Publish Thought</span>
            </button>
            <button id="cancelEdit" onclick="cancelEditing()" class="hidden mt-2 text-[10px] uppercase tracking-widest text-red-400 hover:text-red-600">Cancel Editing</button>
        </div>
    </div>

    <!-- Reader Section Message -->
    <div id="readerNotice" class="text-center mb-16 hidden">
        <p class="text-gray-400 text-sm italic font-light tracking-wide">Exploring the depths of silence through the words of Hassan Jatoi.</p>
    </div>

    <!-- Feed Section -->
    <div class="mb-24">
        <div class="flex items-center gap-4 mb-12 justify-center">
            <span class="h-[1px] flex-grow max-w-[50px] bg-gray-100"></span>
            <h3 class="author-brand text-xs text-gray-400 tracking-[0.4em]">The Collection</h3>
            <span class="h-[1px] flex-grow max-w-[50px] bg-gray-100"></span>
        </div>
        
        <div id="feed" class="space-y-12">
            <div class="text-center text-gray-300 py-10 italic animate-pulse font-serif">Summoning the ink...</div>
        </div>
    </div>
</div>

<footer class="mt-auto py-16 text-center border-t border-gray-50 bg-[#fafafa]">
    <a href="https://hassanalipoetry.vercel.app/" 
       target="_blank" 
       class="inline-block group">
        <span class="text-[10px] text-gray-400 tracking-[0.4em] uppercase block mb-4">Discover More Works</span>
        <span class="text-2xl font-serif italic text-gray-800 border-b border-transparent group-hover:border-gray-800 transition-all duration-500 pb-1">
            Poetry Portfolio <span class="gold-accent">→</span>
        </span>
    </a>
</footer>

<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 hidden bg-[#1a1a1a] text-white px-10 py-4 rounded-full shadow-2xl transition-opacity duration-500 z-50 text-xs uppercase tracking-[0.2em] font-medium border border-gray-800"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'silent-souls-v2';
    
    const MASTER_CODE = "0786";

    let currentUser = null;
    let isAuthor = false;
    let editingPostId = null;

    async function firebaseRetry(fn, retries = 5, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try { return await fn(); } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
        }
    }

    async function checkAuthorPermission(user) {
        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'authorSettings');
        try {
            const configSnap = await firebaseRetry(() => getDoc(configRef));
            if (!configSnap.exists()) {
                // If it's the very first time, whoever lands here becomes the author ID
                await firebaseRetry(() => setDoc(configRef, { authorUid: user.uid, name: "Hassan Jatoi" }));
                isAuthor = true;
            } else {
                // Check if the current user UID matches the saved author UID
                isAuthor = configSnap.data().authorUid === user.uid;
            }

            // UI logic based on permission
            const authorBox = document.getElementById('authorSection');
            const readerNotice = document.getElementById('readerNotice');
            
            if (isAuthor) {
                authorBox.classList.remove('hidden');
                readerNotice.classList.add('hidden');
            } else {
                authorBox.classList.add('hidden');
                readerNotice.classList.remove('hidden');
            }
        } catch (error) { 
            console.error("Permission error:", error);
            // Default to showing the box if checking fails, but it still won't publish without MASTER_CODE
            document.getElementById('authorSection').classList.remove('hidden');
        }
    }

    // Initialize Auth
    async function initAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await checkAuthorPermission(user);
            setupFeedListener();
        }
    });

    initAuth();

    function setupFeedListener() {
        const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'articles');
        onSnapshot(postsRef, (snapshot) => {
            const articles = [];
            snapshot.forEach((doc) => {
                articles.push({ id: doc.id, ...doc.data() });
            });
            articles.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            renderFeed(articles);
        }, (error) => {
            console.error("Snapshot error:", error);
        });
    }

    window.publishPost = async function() {
        const codeInput = document.getElementById('accessCode');
        if (codeInput.value !== MASTER_CODE) {
            showToast("Access Denied");
            return;
        }

        const textArea = document.getElementById('userInput');
        const text = textArea.value.trim();
        const btn = document.getElementById('publishBtn');

        if (text === "") { showToast("Empty Inkwell"); return; }

        btn.disabled = true;
        document.getElementById('btnText').innerText = "Processing...";

        try {
            if (editingPostId) {
                const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'articles', editingPostId);
                await firebaseRetry(() => updateDoc(postRef, { content: text, lastEdited: serverTimestamp() }));
                showToast("Archive Updated");
                cancelEditing();
            } else {
                await firebaseRetry(() => addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'articles'), {
                    content: text,
                    createdAt: serverTimestamp(),
                    authorId: "Hassan Jatoi",
                    uid: currentUser?.uid || "unknown"
                }));
                textArea.value = "";
                showToast("Published");
            }
            codeInput.value = ""; 
        } catch (error) {
            showToast("Server Error");
        } finally {
            btn.disabled = false;
            document.getElementById('btnText').innerText = editingPostId ? "Update Thought" : "Publish Thought";
        }
    };

    window.editPost = function(id, content) {
        editingPostId = id;
        const textArea = document.getElementById('userInput');
        textArea.value = content;
        document.getElementById('btnText').innerText = "Update Thought";
        document.getElementById('cancelEdit').classList.remove('hidden');
        window.scrollTo({ top: document.getElementById('authorSection').offsetTop - 20, behavior: 'smooth' });
        textArea.focus();
    };

    window.cancelEditing = function() {
        editingPostId = null;
        document.getElementById('userInput').value = "";
        document.getElementById('accessCode').value = "";
        document.getElementById('btnText').innerText = "Publish Thought";
        document.getElementById('cancelEdit').classList.add('hidden');
    };

    window.deletePost = async function(id) {
        const code = prompt("Enter Master Code to Remove:");
        if (code !== MASTER_CODE) {
            showToast("Unauthorized");
            return;
        }
        
        try {
            await firebaseRetry(() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'articles', id)));
            showToast("Removed");
        } catch (e) { showToast("Failed"); }
    };

    window.sharePost = function(text) {
        const shareLink = `"${text}"\n\n— Hassan Jatoi\n\nRead more at Silent Souls:\n${window.location.href}`;
        const dummy = document.createElement("textarea");
        document.body.appendChild(dummy);
        dummy.value = shareLink;
        dummy.select();
        document.execCommand("copy");
        document.body.removeChild(dummy);
        showToast("Copied");
    };

    function renderFeed(articles) {
        const feed = document.getElementById('feed');
        if (articles.length === 0) {
            feed.innerHTML = '<div class="text-center text-gray-300 py-20 italic font-serif">The archive is silent.</div>';
            return;
        }

        feed.innerHTML = articles.map(post => {
            const cleanContent = post.content.replace(/`/g, '\\`').replace(/\$/g, '\\$');
            return `
            <div class="post-card p-12 rounded-[2rem] border border-gray-50 text-center relative group">
                ${isAuthor ? `
                <div class="absolute top-8 right-8 flex gap-3 action-btn">
                    <button onclick="editPost('${post.id}', \`${cleanContent}\`)" class="p-2 text-gray-300 hover:text-gray-900 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button onclick="deletePost('${post.id}')" class="p-2 text-gray-300 hover:text-red-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                ` : ''}
                
                <p class="text-3xl text-gray-800 leading-[1.6] font-serif font-light whitespace-pre-wrap italic">"${escapeHtml(post.content)}"</p>
                
                <div class="mt-12 pt-8 border-t border-gray-50 flex flex-col items-center gap-6">
                    <div class="flex flex-col items-center gap-2">
                        <span class="text-[9px] font-medium text-gray-400 uppercase tracking-[0.3em]">
                            ${post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString('en-GB', {day: 'numeric', month: 'long', year: 'numeric'}) : 'Recently'}
                        </span>
                        <span class="author-brand text-[10px] text-gray-800 font-bold italic tracking-[0.2em]">— Hassan Jatoi</span>
                    </div>
                    
                    <button onclick="sharePost(\`${cleanContent}\`)" class="flex items-center gap-3 text-[10px] uppercase tracking-widest text-gray-400 hover:text-gray-900 transition-all border border-gray-100 rounded-full px-8 py-3 hover:bg-white hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                        Share Thought
                    </button>
                </div>
            </div>
            `;
        }).join('');
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>
